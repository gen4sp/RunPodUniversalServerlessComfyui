name: Docker Build Check

on:
  push:
    branches-ignore:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  docker-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: comfyui-serverless:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          echo "‚úÖ Docker –æ–±—Ä–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
          echo "üì¶ –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞:"
          docker images comfyui-serverless:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

      - name: Validate required files
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
          test -f Dockerfile && echo "‚úÖ Dockerfile –Ω–∞–π–¥–µ–Ω" || (echo "‚ùå Dockerfile –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)
          test -f snapshot.json && echo "‚úÖ snapshot.json –Ω–∞–π–¥–µ–Ω" || (echo "‚ùå snapshot.json –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)
          test -f requirements.txt && echo "‚úÖ requirements.txt –Ω–∞–π–¥–µ–Ω" || (echo "‚ùå requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)
          test -f start.sh && echo "‚úÖ start.sh –Ω–∞–π–¥–µ–Ω" || (echo "‚ùå start.sh –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)
          echo "‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç"

      - name: Validate snapshot.json
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ snapshot.json..."
          python3 -m json.tool snapshot.json > /dev/null && echo "‚úÖ snapshot.json –≤–∞–ª–∏–¥–µ–Ω" || (echo "‚ùå snapshot.json –Ω–µ–≤–∞–ª–∏–¥–µ–Ω" && exit 1)