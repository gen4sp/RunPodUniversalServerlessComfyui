name: Auto Release

on:
  push:
    branches:
      - master
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Get commit info
        id: commit
        run: |
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT

      - name: Create tag
        id: tag
        run: |
          TAG="v${{ steps.date.outputs.date }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Auto release $TAG - ${{ steps.commit.outputs.commit_message }}"
          git push origin "$TAG"

      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€ÐµÐ»Ð¸Ð· ComfyUI Serverless Template

          ### ðŸ“ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          - **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚**: `${{ steps.commit.outputs.short_sha }}`
          - **Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ**: ${{ steps.commit.outputs.commit_message }}
          - **ÐÐ²Ñ‚Ð¾Ñ€**: ${{ steps.commit.outputs.author }}
          - **Ð”Ð°Ñ‚Ð°**: ${{ steps.date.outputs.date }}

          ### ðŸ³ Docker Ð¾Ð±Ñ€Ð°Ð·
          Ð­Ñ‚Ð¾Ñ‚ Ñ€ÐµÐ»Ð¸Ð· ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Docker Ð¾Ð±Ñ€Ð°Ð· Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ ComfyUI Ð½Ð° Runpod Serverless.

          ### ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
          1. Fork ÑÑ‚Ð¾Ð³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
          2. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Runpod Volume (50+ GB)
          3. Ð”ÐµÐ¿Ð»Ð¾Ð¹Ñ‚Ðµ Serverless Endpoint Ñ GitHub Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸ÐµÐ¹
          4. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ volume Ðº `/runpod-volume`

          ### âš¡ Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸
          - **Ð’Ñ€ÐµÐ¼Ñ Ñ…Ð¾Ð»Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÑÑ‚Ð°Ñ€Ñ‚Ð°**: â‰ˆ 35-45 Ñ Ð½Ð° A6000
          - **ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ñ… Ð½Ð¾Ð´**: Ñ‡ÐµÑ€ÐµÐ· snapshot.json
          - **Persistent storage**: Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð½Ð° Runpod Volume
          - **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹**

          ### ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
          ÐŸÐ¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ð² [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/readme.md)
          EOF

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            --title "ComfyUI Serverless ${{ steps.tag.outputs.tag }}" \
            --notes-file release_notes.md \
            --latest \
            ./Dockerfile \
            ./snapshot.json \
            ./requirements.txt \
            ./readme.md